param($ResourceGroupName, $ConnectionName)

$ErrorActionPreference = "Stop"

$Conn = Get-AutomationConnection -Name $ConnectionName

Connect-AzAccount -ServicePrincipal -Tenant $Conn.TenantId `
    -ApplicationId $Conn.ApplicationId -CertificateThumbprint $Conn.CertificateThumbprint

$SettingsString = "{ ""AntimalwareEnabled"": true }"
$list = Get-AzVM -ResourceGroupName $ResourceGroupName
$list | ForEach-Object {
    $name = $_.Name
    Write-Host "Updating $name"
    Set-AzVMExtension -ResourceGroupName $ResourceGroupName -Location $_.Location -VMName $name -Name "IaaSAntimalware" -Publisher "Microsoft.Azure.Security" -Type "IaaSAntimalware" -TypeHandlerVersion "1.3" -SettingString $SettingsString
    Write-Host "Anitmalware enabled on $name"
}
